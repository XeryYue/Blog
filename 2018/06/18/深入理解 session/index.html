<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="由于 HTTP 协议的无状态特点, 我们在平时的开发中为了良好的用户体验, 往往会需要 cookie 或者 session 的介入, 特别是在授权与登录认证方面. 这里我通过编写一个简单的 session 中间件来深入理解一下 session.">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解 session">
<meta property="og:url" content="http://zhangxiang958.github.io/2018/06/18/深入理解 session/index.html">
<meta property="og:site_name" content="Shawn&#39;s blog">
<meta property="og:description" content="由于 HTTP 协议的无状态特点, 我们在平时的开发中为了良好的用户体验, 往往会需要 cookie 或者 session 的介入, 特别是在授权与登录认证方面. 这里我通过编写一个简单的 session 中间件来深入理解一下 session.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-06-18T13:54:56.005Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解 session">
<meta name="twitter:description" content="由于 HTTP 协议的无状态特点, 我们在平时的开发中为了良好的用户体验, 往往会需要 cookie 或者 session 的介入, 特别是在授权与登录认证方面. 这里我通过编写一个简单的 session 中间件来深入理解一下 session.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://zhangxiang958.github.io/2018/06/18/深入理解 session/"/>





  <title>深入理解 session | Shawn's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shawn's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">大道至简, 悟在天成</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zhangxiang958.github.io/2018/06/18/深入理解 session/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shawn">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://ofsur12wi.bkt.clouddn.com/916161494.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shawn's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">深入理解 session</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-18T21:54:24+08:00">
                2018-06-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HTTP/" itemprop="url" rel="index">
                    <span itemprop="name">HTTP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 浏览
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>由于 HTTP 协议的无状态特点, 我们在平时的开发中为了良好的用户体验, 往往会需要 cookie 或者 session 的介入, 特别是在授权与登录认证方面. 这里我通过编写一个简单的 session 中间件来深入理解一下 session.<br><a id="more"></a></p>
<h2 id="session-的本质"><a href="#session-的本质" class="headerlink" title="session 的本质"></a>session 的本质</h2><p>我们知道 session 与 cookie 是分不开的, session 其实是基于 cookie 的, 所以如果你的浏览器禁用了 cookie 的话, 那么 session 也会用不了. 为什么需要 cookie 与 session 呢? 是因为 HTTP 协议是无状态的, 上一次的请求与下一次的请求之间并无关联, 所以我们需要某些东西来记住我们上一次是做了什么操作, 然后在下一个请求才能顺延上一步的结果.<br>例如, 我们整个网站中的关键操作, 比如购物, 将物品放入购物车, 对某个文档进行修改等等这些操作, 都需要验证了身份之后才可以进行操作, 但是我们在用户体验的角度上来看, 不可能在用户每次执行这些操作的时候, 都弹出一个登录框来要求用户进行登录, 这样严重降低了良好的用户体验, 所以我们就需要利用 session 来记住用户的登录态, 让操作更流畅.</p>
<h3 id="与-Cookie-的区别"><a href="#与-Cookie-的区别" class="headerlink" title="与 Cookie 的区别"></a>与 Cookie 的区别</h3><p>我们知道, 对于简单的 Cookie 来说, 我们需要设置 Cookie 的 domain, path, expires 基本属性值, 这样我们就可以在客户端存储数据了, 而且这样的数据是每次请求的时候都会在 HTTP 的头部带上值的, 也就是说我们可以在请求头部中获取数据, 并且做相对应的操作, 当然服务端也可以通过 Set-Cookie 响应头部来设置 Cookie. 而 Session 是基于 Cookie 的, 也就是说, 我们在设置一个 Session 的时候, 实际上是设置了一个 Cookie 的键值对.<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: <span class="attribute">key</span>=value; <span class="attribute">path</span>=/; <span class="attribute">Expires</span>=3000;</span><br></pre></td></tr></table></figure></p>
<p>而 key 是自己定的, 用来读取对应的 session 在客户端的信息, 而在客户端存储的 session 的数据, 就是 sessionId.我们利用这个 sessionId 在服务端存储了对应的数据, 也即是说, sessionId 在服务端对应的是一个对象, 里面存储了很多数据:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store 是一个服务端的简单对象</span></span><br><span class="line"><span class="attribute">store</span>: &#123;</span><br><span class="line">    <span class="attribute">sessionId1</span>: &#123;</span><br><span class="line">        <span class="attribute">nick</span>: <span class="string">'shawn'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attribute">sessionId2</span>: &#123;</span><br><span class="line">        <span class="attribute">nick</span>: <span class="string">'zhang'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attribute">sessionId3</span>: &#123;</span><br><span class="line">        <span class="attribute">nick</span>: <span class="string">'cheung'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="服务端存储数据的优势"><a href="#服务端存储数据的优势" class="headerlink" title="服务端存储数据的优势"></a>服务端存储数据的优势</h3><p>那么, 既然 cookie 本身就可以存储数据, 我们何必使用 seesion 呢? 这个在于 cookie 与 session 其实都是为了解决 HTTP 协议无状态这个问题的, 只不过 Cookie 是客户端方案, Session 是服务端方案, 虽然面对不同的场景, 两者有其适合的用法, 但是对比起 Cookie, Seesion 在信息保护方面可能会更好, 因为一般 cookie 的数据都不加密, 这意味着是明文, 甚至用户可以通过浏览器的开发者工具就可以直接看到, 不便于存储一些敏感的数据, 但是 session 在客户端只有一个 sessionId, 其对应的数据存储在服务端, 增强了安全指数. 而且另一方面, cookie 头部在每次请求都会带上, 如果 cookie 的数据过多这无疑增加了每次传输数据的网络负担, 而使用 session 可以减轻这方面的负荷.</p>
<h3 id="如何存储与处理-session"><a href="#如何存储与处理-session" class="headerlink" title="如何存储与处理 session"></a>如何存储与处理 session</h3><p>为了更好地理解 session 机制, 我们来试试造一个 session 中间件:<br>先创建存储相关的对象, 我们这里需要将存储相关的操作分离出来在 memory_store.js 里面, 这样的好处在于能够统一接口, 方便接入 mysql, redis 等第三方数据库客户端来存储 session 数据<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">module.exports = <span class="class"><span class="keyword">class</span> <span class="title">MemoryStore</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="comment">// 存储全部的 session 数据</span></span><br><span class="line">    <span class="keyword">this</span>.store = &#123;&#125;;</span><br><span class="line">    <span class="comment">// 存储 ttl 的定时器 id</span></span><br><span class="line">    <span class="keyword">this</span>.timers = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> (sid) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!sid) <span class="keyword">return</span> undefined;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store[sid];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> (sid, value, ttl) &#123;</span><br><span class="line">    <span class="comment">// 重新设置之前先清除之前的定时器, 防止内存泄漏</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.store[sid]) clearTimeout(<span class="keyword">this</span>.timers[sid]);</span><br><span class="line">    <span class="comment">// 保存值</span></span><br><span class="line">    <span class="keyword">this</span>.store[sid] = value;</span><br><span class="line">    <span class="comment">// 设置多少时间后清除数据与定时器</span></span><br><span class="line">    <span class="keyword">this</span>.timers[sid] = setTimeout(() =&gt; &#123;</span><br><span class="line">      Reflect.deleteProperty(<span class="keyword">this</span>.store, sid);</span><br><span class="line">      Reflect.deleteProperty(<span class="keyword">this</span>.timers, sid);</span><br><span class="line">    &#125;, +ttl);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  destory (sid) &#123;</span><br><span class="line">    <span class="comment">// 与上面逻辑类似, 但是是对应某个对应的 sid 的</span></span><br><span class="line">    clearTimeout(<span class="keyword">this</span>.timers[sid]);</span><br><span class="line"></span><br><span class="line">    Reflect.deleteProperty(<span class="keyword">this</span>.store, sid);</span><br><span class="line">    Reflect.deleteProperty(<span class="keyword">this</span>.timers, sid);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>下面创建一个简单的基于 koa 框架的 session 中间件(实现上参考了 koa-session-minimal):<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MemoryStore = <span class="built_in">require</span>(<span class="string">'./memory_store'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> ONE_DAY = <span class="number">1000</span> * <span class="number">3600</span> * <span class="number">24</span>;</span><br><span class="line"><span class="comment">// 获取 cookie 相关</span></span><br><span class="line"><span class="keyword">const</span> getCookieOpts = <span class="function">(<span class="params">opts = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> options = <span class="built_in">Object</span>.assign(&#123;</span><br><span class="line">    maxAge: <span class="number">0</span>,</span><br><span class="line">    path: <span class="string">'/'</span>,</span><br><span class="line">    httpOnly: <span class="literal">true</span></span><br><span class="line">  &#125;, opts);</span><br><span class="line">  <span class="keyword">if</span> (!(options.maxAge &gt;= <span class="number">0</span>)) options.maxAge = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> options;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 删除 session 数据</span></span><br><span class="line"><span class="keyword">const</span> deleteSession = <span class="function">(<span class="params">ctx, key, cookieOpts, store, sid</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> tmp = <span class="built_in">Object</span>.assign(&#123;&#125;, cookieOpts);</span><br><span class="line">  <span class="built_in">Reflect</span>.deleteProperty(tmp, <span class="string">'maxAge'</span>);</span><br><span class="line">  <span class="comment">// 设置一个空值的 cookie 为删除</span></span><br><span class="line">  ctx.cookies.set(key, <span class="literal">null</span>, tmp);</span><br><span class="line">  <span class="comment">// 删除 session 对象中的数据</span></span><br><span class="line">  store.destory(<span class="string">`<span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;sid&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 保存 session 数据</span></span><br><span class="line"><span class="keyword">const</span> saveSession = <span class="function">(<span class="params">ctx, key, cookieOpts, store, sid</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ttl = cookieOpts.maxAge &gt; <span class="number">0</span> ? cookieOpts.maxAge : ONE_DAY;</span><br><span class="line">  <span class="comment">// 设置 cookie 值</span></span><br><span class="line">  ctx.cookies.set(key, sid, cookieOpts);</span><br><span class="line">  <span class="comment">// 在 session 对象保存值</span></span><br><span class="line">  store.set(<span class="string">`<span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;sid&#125;</span>`</span>, ctx.session, ttl);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 检查 session 的类型, 保证 session 是一个对象</span></span><br><span class="line"><span class="keyword">const</span> checkSession = <span class="function">(<span class="params">ctx</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ctx.session || <span class="keyword">typeof</span> ctx.session !== <span class="string">'object'</span>) ctx.session = &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">Session</span> (<span class="params">options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> opt = options;</span><br><span class="line">  <span class="keyword">const</span> key = opt.key || <span class="string">'session:middlewares'</span>;</span><br><span class="line">  <span class="keyword">const</span> cookie = getCookieOpts(opt.cookie);</span><br><span class="line">  <span class="keyword">const</span> store = opt.store || <span class="keyword">new</span> MemoryStore();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> oldSid = ctx.cookies.get(key);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> sid = oldSid;</span><br><span class="line">    <span class="comment">// 暴露改变 sessionId 的接口</span></span><br><span class="line">    ctx.sessionHandler = &#123;</span><br><span class="line">      generatorId: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 随机的字符串</span></span><br><span class="line">        sid = <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> sid;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果没有 sid, 也就是之前没有设置过</span></span><br><span class="line">    <span class="keyword">if</span> (!sid) &#123;</span><br><span class="line">      <span class="comment">// 生成 sid</span></span><br><span class="line">      ctx.sessionHandler.generatorId();</span><br><span class="line">      <span class="comment">// 这里的 session 对象只是一个暂存对象, 最后的数据是放到 store 的对象里面的</span></span><br><span class="line">      ctx.session = &#123;&#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 取出对应的值</span></span><br><span class="line">      ctx.session = store.get(<span class="string">`<span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;sid&#125;</span>`</span>);</span><br><span class="line">      <span class="comment">// 保证 session 是对像值</span></span><br><span class="line">      checkSession(ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasData = <span class="built_in">Object</span>.keys(ctx.session).length &gt; <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果 sid 没有变化</span></span><br><span class="line">    <span class="keyword">if</span> (sid === oldSid) &#123;</span><br><span class="line">      <span class="comment">// 如果数据没有变化, 那么就直接退出</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">JSON</span>.stringify(ctx.session) === <span class="built_in">JSON</span>.stringify(store.get(<span class="string">`<span class="subst">$&#123;key&#125;</span>:<span class="subst">$&#123;sid&#125;</span>`</span>))) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">if</span> (hasData) &#123;</span><br><span class="line">        saveSession(ctx, key, cookie, store, sid);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteSession(ctx, key, cookie, store, sid);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 如果没有 oldSid 或者 sid 发生了变化</span></span><br><span class="line">      <span class="keyword">if</span> (oldSid) deleteSession(ctx, key, cookie, store, sid);</span><br><span class="line">      <span class="keyword">if</span> (hasData) saveSession(ctx, key, cookie, store, sid);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>因为要标记客户端, 所以需要确保 sessionId 的唯一性. 其实上面的逻辑很简单, 其实总得来说就是 seesion 需要生成一个唯一的 id, 对应服务端的全局 session 对象中的某个次级对象, 里面存储着更多数据, 然后在请求来临的时候判断 cookie 是否有我们预设的 key 对应的 sessionId 值, 如果没有则生成一个, 有则接下一步, 然后将数据暂时放在请求上下文的 session 属性中, 当请求处理完毕后, 将数据放入到真正的全局对象中去.</p>
<h2 id="session-的安全性"><a href="#session-的安全性" class="headerlink" title="session 的安全性"></a>session 的安全性</h2><p>经过上面, 我们大致明白了 session 的处理过程, 那么它存不存在安全问题呢? 答案是必然的.</p>
<h3 id="为什么需要设置-httpOnly-属性"><a href="#为什么需要设置-httpOnly-属性" class="headerlink" title="为什么需要设置 httpOnly 属性"></a>为什么需要设置 httpOnly 属性</h3><p>我们在使用 session 的时候, 设置 cookie 的时候需要保证 cookie 的 httpOnly 属性值被设置为 true. 因为客户端的数据并不值得信任, 我们需要确保 sessionId 不会被读写, 如果能够被读, 那么就可以进行伪造, 如果可以进行写, 那么就可以修改, 我们不能允许这样的情况出现, 所以我们需要设置 cookie 的 httpOnly 属性, 这样客户端的脚本是不能对这个 cookie 值进行读写的, 意味着 js 不能对此值进行读写操作, 在一定的程度上防范了 XSS 攻击(跨站脚本工具).</p>
<h3 id="为什么-sessionId-需要随机"><a href="#为什么-sessionId-需要随机" class="headerlink" title="为什么 sessionId 需要随机"></a>为什么 sessionId 需要随机</h3><p>这个问题的答案是显而易见的, 攻击者需要的就是知道 sessionId 与真正数据的对应关系, 比如攻击者拥有了班级的学号与姓名的对应表, 正好开发者在实现的时候, 使用了这个对应关系, 比如张三的学号为 1, 李四的学号为 2, 而他们登录信息对应的 sessionId 正好就是 1 与 2. 那么知道了这个关系, 攻击者现在就可以随心所欲地进行登录伪造了. 所以我们需要对 sessionId 进行随机化, 让攻击者猜不透 id 与数据的对应关系, 甚至在过期之后我们需要及时更换对应的 id, 这样才能提高安全性.</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Shawn
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://zhangxiang958.github.io/2018/06/18/深入理解 session/" title="深入理解 session">http://zhangxiang958.github.io/2018/06/18/深入理解 session/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/10/理解模板引擎/" rel="next" title="理解模板引擎">
                <i class="fa fa-chevron-left"></i> 理解模板引擎
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMjExMy84Njc3"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://ofsur12wi.bkt.clouddn.com/916161494.jpg"
                alt="Shawn" />
            
              <p class="site-author-name" itemprop="name">Shawn</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">69</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zhangxiang958" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:shawncheung702@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#session-的本质"><span class="nav-number">1.</span> <span class="nav-text">session 的本质</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#与-Cookie-的区别"><span class="nav-number">1.1.</span> <span class="nav-text">与 Cookie 的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端存储数据的优势"><span class="nav-number">1.2.</span> <span class="nav-text">服务端存储数据的优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何存储与处理-session"><span class="nav-number">1.3.</span> <span class="nav-text">如何存储与处理 session</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session-的安全性"><span class="nav-number">2.</span> <span class="nav-text">session 的安全性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么需要设置-httpOnly-属性"><span class="nav-number">2.1.</span> <span class="nav-text">为什么需要设置 httpOnly 属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么-sessionId-需要随机"><span class="nav-number">2.2.</span> <span class="nav-text">为什么 sessionId 需要随机</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shawn</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
